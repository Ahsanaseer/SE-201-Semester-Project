<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Pulse Chain GIKI</title>
    <link rel="icon" type="image/png" href="PICS/Pulse Chain GIKI.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="PICS/Pulse_Chain_GIKI Logo Icon.png" alt="Pulse Chain GIKI Logo" class="logo-icon-img">
                <div class="logo-text">Pulse Chain GIKI</div>
            </div>

            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <span class="menu-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />
                        </svg>
                    </span>
                    <span class="menu-text">Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-page="donors">
                    <span class="menu-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                    </span>
                    <span class="menu-text">Donors</span>
                </a>
                <a href="#" class="menu-item" data-page="requests">
                    <span class="menu-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                        </svg>
                    </span>
                    <span class="menu-text">Requests</span>
                </a>
                <a href="#" class="menu-item" data-page="analytics">
                    <span class="menu-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10" />
                            <line x1="12" y1="20" x2="12" y2="4" />
                            <line x1="6" y1="20" x2="6" y2="14" />
                        </svg>
                    </span>
                    <span class="menu-text">Analytics</span>
                </a>
            </nav>

            <div class="user-profile-section">
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12" />
                        <line x1="3" y1="6" x2="21" y2="6" />
                        <line x1="3" y1="18" x2="21" y2="18" />
                    </svg>
                </button>
                <h1 class="header-title">Admin Dashboard</h1>
                <div class="header-actions">
                    <button class="mobile-search-btn" id="mobileSearchBtn" aria-label="Toggle Search">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                    <div class="search-bar">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" placeholder="Search donors, requests..." id="searchInput">
                    </div>
                    <button class="btn-connect" id="refreshBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            style="margin-right: 6px;">
                            <polyline points="23 4 23 10 17 10" />
                            <polyline points="1 20 1 14 7 14" />
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                        </svg>
                        Refresh
                    </button>
                    <button class="logout-icon-btn" id="logoutBtn" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#800000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">

                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Donors</div>
                            <div class="stat-value" id="totalDonors">0</div>
                            <div class="stat-change">All registered donors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Requests</div>
                            <div class="stat-value" id="totalRequests">0</div>
                            <div class="stat-change">Pending blood requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Available Donors</div>
                            <div class="stat-value" id="availableDonors">0</div>
                            <div class="stat-change">Ready to donate</div>
                        </div>
                    </div>

                    <!-- Hero Card -->
                    <div class="hero-card">
                        <div class="hero-label">PULSE CHAIN GIKI</div>
                        <h2 class="hero-title">Save Lives, Donate Blood</h2>
                        <p class="hero-description">Manage donors, track requests, and ensure timely blood availability
                            across campus. Every donation counts in saving lives.</p>
                        <button class="hero-button" onclick="document.getElementById('refreshBtn').click()">Refresh
                            Data</button>
                    </div>

                    <!-- Donors Section -->
                    <div class="data-section">
                        <div class="section-header">
                            <h2 class="section-title">All Donors</h2>
                            <div class="section-tabs">
                                <button class="tab-button active" data-filter="all">All</button>
                                <button class="tab-button" data-filter="available">Available</button>
                                <button class="tab-button" data-filter="unavailable">Unavailable</button>
                            </div>
                        </div>
                        <div id="donorsContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="12" y1="2" x2="12" y2="6" />
                                        <line x1="12" y1="18" x2="12" y2="22" />
                                        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76" />
                                        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07" />
                                        <line x1="2" y1="12" x2="6" y2="12" />
                                        <line x1="18" y1="12" x2="22" y2="12" />
                                        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24" />
                                        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93" />
                                    </svg>
                                </div>
                                <div class="empty-state-text">Loading donors...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Requests Section -->
                    <div class="data-section">
                        <div class="section-header">
                            <h2 class="section-title">Blood Requests</h2>
                            <div class="section-tabs">
                                <button class="tab-button active" data-filter="all-requests">All</button>
                                <button class="tab-button" data-filter="recent">Recent</button>
                            </div>
                        </div>
                        <div id="requestsContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="12" y1="2" x2="12" y2="6" />
                                        <line x1="12" y1="18" x2="12" y2="22" />
                                        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76" />
                                        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07" />
                                        <line x1="2" y1="12" x2="6" y2="12" />
                                        <line x1="18" y1="12" x2="22" y2="12" />
                                        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24" />
                                        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93" />
                                    </svg>
                                </div>
                                <div class="empty-state-text">Loading requests...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Page -->
                <div id="page-analytics" class="page-content" style="display: none;">
                    <div class="data-section">
                        <div class="section-header">
                            <h2 class="section-title">Analytics & Insights</h2>
                        </div>

                        <!-- Chart Grid -->
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 24px;">
                            <!-- Blood Group Distribution -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Blood Group Distribution</h3>
                                <canvas id="bloodGroupChart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Gender Distribution -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Gender Distribution</h3>
                                <canvas id="genderChart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Availability Status -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Availability Status</h3>
                                <canvas id="availabilityChart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Donations Over Time -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Donations Over Time</h3>
                                <canvas id="donationsOverTimeChart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Requests Over Time -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Blood Requests Over Time</h3>
                                <canvas id="requestsOverTimeChart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Blood Group Requests -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Requests by Blood Group</h3>
                                <canvas id="requestsByBloodGroupChart" style="max-height: 300px;"></canvas>
                            </div>

                            <!-- Monthly Trends -->
                            <div class="stat-card" style="padding: 24px;">
                                <h3
                                    style="margin: 0 0 20px 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">
                                    Monthly Trends</h3>
                                <canvas id="monthlyTrendsChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>



    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="confirmModalTitle">Confirm Action</h2>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage" style="color: var(--text-primary); margin-bottom: 24px; line-height: 1.6;">
                </p>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="confirmModalCancel" style="min-width: 100px;">Cancel</button>
                    <button class="btn btn-primary" id="confirmModalConfirm" style="min-width: 100px;">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAdminData, adminDeleteDonor, adminDeleteRequest, adminUpdateDonorAvailability, approveRequest } from './js/admin.js';
        import { getCurrentUser, logOut, onAuthStateChange, isAdmin } from './js/login.js';
        import { getAllDonors } from './js/donor.js';
        import { showSuccessToast, showErrorToast } from './js/toast.js';

        const donorsContainer = document.getElementById('donorsContainer');
        const requestsContainer = document.getElementById('requestsContainer');
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const searchInput = document.getElementById('searchInput');
        const mobileSearchBtn = document.getElementById('mobileSearchBtn');
        const searchBar = document.querySelector('.search-bar');
        const headerTitle = document.querySelector('.header-title');

        // Chart instances
        let charts = {};

        // Confirmation modal elements
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalConfirm = document.getElementById('confirmModalConfirm');
        const confirmModalCancel = document.getElementById('confirmModalCancel');
        const closeConfirmModal = document.getElementById('closeConfirmModal');

        // Confirmation modal promise resolver
        let confirmResolve = null;

        // Custom confirm function
        function showConfirm(title, message, isDanger = false) {
            return new Promise((resolve) => {
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;

                // Style confirm button based on action type
                if (isDanger) {
                    confirmModalConfirm.className = 'btn';
                    confirmModalConfirm.style.backgroundColor = '#800000';
                    confirmModalConfirm.style.color = '#ffffff';
                    confirmModalConfirm.style.border = 'none';
                } else {
                    confirmModalConfirm.className = 'btn btn-primary';
                    confirmModalConfirm.style.backgroundColor = '';
                    confirmModalConfirm.style.color = '';
                    confirmModalConfirm.style.border = '';
                }

                confirmModal.style.display = 'flex';
                confirmResolve = resolve;
            });
        }

        // Handle confirm button
        confirmModalConfirm.addEventListener('click', () => {
            if (confirmResolve) {
                confirmModal.style.display = 'none';
                confirmResolve(true);
                confirmResolve = null;
            }
        });

        // Handle cancel button
        confirmModalCancel.addEventListener('click', () => {
            if (confirmResolve) {
                confirmModal.style.display = 'none';
                confirmResolve(false);
                confirmResolve = null;
            }
        });

        // Handle close button
        closeConfirmModal.addEventListener('click', () => {
            if (confirmResolve) {
                confirmModal.style.display = 'none';
                confirmResolve(false);
                confirmResolve = null;
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === confirmModal && confirmResolve) {
                confirmModal.style.display = 'none';
                confirmResolve(false);
                confirmResolve = null;
            }
        });

        // Mobile menu toggle
        // Mobile menu toggle
        mobileMenuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            if (sidebar.classList.contains('open') &&
                !sidebar.contains(e.target) &&
                !mobileMenuToggle.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Mobile search toggle
        if (mobileSearchBtn && searchBar) {
            mobileSearchBtn.addEventListener('click', () => {
                searchBar.classList.toggle('show-mobile');
                if (searchBar.classList.contains('show-mobile')) {
                    searchInput.focus();
                }
            });
        }

        // Page navigation
        document.querySelectorAll('.menu-item[data-page]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.getAttribute('data-page');
                switchPage(page);

                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
                item.classList.add('active');
            });
        });

        function switchPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');

            // For donors and requests, show dashboard and scroll to section
            if (page === 'donors' || page === 'requests') {
                const dashboardPage = document.getElementById('page-dashboard');
                if (dashboardPage) {
                    dashboardPage.style.display = 'block';
                    headerTitle.textContent = page === 'donors' ? 'Donors Management' : 'Blood Requests';

                    // Scroll to the relevant section after a short delay
                    setTimeout(() => {
                        const section = page === 'donors'
                            ? document.getElementById('donorsContainer')?.closest('.data-section')
                            : document.getElementById('requestsContainer')?.closest('.data-section');
                        if (section) {
                            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                }
                return;
            }

            // Show selected page
            const pageElement = document.getElementById(`page-${page}`);
            if (pageElement) {
                pageElement.style.display = 'block';

                // Update header title
                const titles = {
                    'dashboard': 'Admin Dashboard',
                    'analytics': 'Analytics & Insights'
                };
                headerTitle.textContent = titles[page] || 'Admin Dashboard';

                // Load analytics if switching to analytics page
                if (page === 'analytics') {
                    loadAnalytics();
                }
            }
        }

        // Check admin access
        const adminSession = sessionStorage.getItem('adminLoggedIn');
        const adminEmail = sessionStorage.getItem('adminEmail');

        if (adminSession === 'true' && adminEmail === 'admin@gmail.com') {
            loadData();
        } else {
            onAuthStateChange(async (user) => {
                if (!user) {
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('admin') === 'true') {
                        sessionStorage.setItem('adminLoggedIn', 'true');
                        sessionStorage.setItem('adminEmail', 'admin@gmail.com');
                        loadData();
                        return;
                    }
                    window.location.href = window.getPath('index');
                    return;
                }

                const adminStatus = await isAdmin();
                if (!adminStatus && user.email !== 'admin@gmail.com') {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = window.getPath('index');
                    return;
                }

                loadData();
            });
        }

        async function loadData() {
            const result = await getAdminData();

            if (result.success) {
                updateStats(result.donors, result.requests);
                displayDonors(result.donors);
                displayRequests(result.requests);

                // Store data globally for analytics
                window.adminData = {
                    donors: result.donors,
                    requests: result.requests
                };
            } else {
                showAlert('Failed to load data. Please try again.', 'error');
                donorsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><div class="empty-state-text">Failed to load donors</div></div>';
                requestsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><div class="empty-state-text">Failed to load requests</div></div>';
            }
        }

        function loadAnalytics() {
            // Reload data if not available
            if (!window.adminData) {
                loadData().then(() => {
                    if (window.adminData) {
                        generateCharts(window.adminData.donors, window.adminData.requests);
                    }
                });
            } else {
                generateCharts(window.adminData.donors, window.adminData.requests);
            }
        }

        function generateCharts(donors, requests) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            // Blood Group Distribution (Pie Chart)
            const bloodGroupCounts = {};
            donors.forEach(donor => {
                bloodGroupCounts[donor.bloodGroup] = (bloodGroupCounts[donor.bloodGroup] || 0) + 1;
            });
            const bloodGroups = Object.keys(bloodGroupCounts).sort();
            const bloodGroupData = bloodGroups.map(bg => bloodGroupCounts[bg]);

            charts.bloodGroup = new Chart(document.getElementById('bloodGroupChart'), {
                type: 'pie',
                data: {
                    labels: bloodGroups,
                    datasets: [{
                        data: bloodGroupData,
                        backgroundColor: [
                            '#800000', '#f59e0b', '#10b981', '#4a0404',
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gender Distribution (Doughnut Chart)
            const genderCounts = {};
            donors.forEach(donor => {
                genderCounts[donor.gender] = (genderCounts[donor.gender] || 0) + 1;
            });

            charts.gender = new Chart(document.getElementById('genderChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: ['#4a0404', '#ec4899', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Availability Status (Bar Chart)
            const availableCount = donors.filter(d => d.availability === 'Yes').length;
            const unavailableCount = donors.filter(d => d.availability === 'No').length;

            charts.availability = new Chart(document.getElementById('availabilityChart'), {
                type: 'bar',
                data: {
                    labels: ['Available', 'Unavailable'],
                    datasets: [{
                        label: 'Donors',
                        data: [availableCount, unavailableCount],
                        backgroundColor: ['#10b981', '#800000']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Donations Over Time (Line Chart)
            const donationsByDate = {};
            donors.forEach(donor => {
                const date = new Date(donor.timestamp);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                donationsByDate[monthYear] = (donationsByDate[monthYear] || 0) + 1;
            });
            const sortedDates = Object.keys(donationsByDate).sort();
            const donationsData = sortedDates.map(date => donationsByDate[date]);

            charts.donationsOverTime = new Chart(document.getElementById('donationsOverTimeChart'), {
                type: 'line',
                data: {
                    labels: sortedDates.map(d => {
                        const [year, month] = d.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Donations',
                        data: donationsData,
                        borderColor: '#4a0404',
                        backgroundColor: 'rgba(74, 4, 4, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Requests Over Time (Line Chart)
            const requestsByDate = {};
            requests.forEach(request => {
                const date = new Date(request.timestamp);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                requestsByDate[monthYear] = (requestsByDate[monthYear] || 0) + 1;
            });
            const sortedRequestDates = Object.keys(requestsByDate).sort();
            const requestsData = sortedRequestDates.map(date => requestsByDate[date]);

            charts.requestsOverTime = new Chart(document.getElementById('requestsOverTimeChart'), {
                type: 'line',
                data: {
                    labels: sortedRequestDates.map(d => {
                        const [year, month] = d.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Requests',
                        data: requestsData,
                        borderColor: '#800000',
                        backgroundColor: 'rgba(128, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Requests by Blood Group (Bar Chart)
            const requestsByBloodGroup = {};
            requests.forEach(request => {
                requestsByBloodGroup[request.bloodGroup] = (requestsByBloodGroup[request.bloodGroup] || 0) + 1;
            });
            const requestBloodGroups = Object.keys(requestsByBloodGroup).sort();
            const requestBloodGroupData = requestBloodGroups.map(bg => requestsByBloodGroup[bg]);

            charts.requestsByBloodGroup = new Chart(document.getElementById('requestsByBloodGroupChart'), {
                type: 'bar',
                data: {
                    labels: requestBloodGroups,
                    datasets: [{
                        label: 'Requests',
                        data: requestBloodGroupData,
                        backgroundColor: '#800000'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Monthly Trends (Combined Bar Chart)
            const allMonths = new Set([...sortedDates, ...sortedRequestDates]);
            const sortedAllMonths = Array.from(allMonths).sort();
            const monthlyDonations = sortedAllMonths.map(month => donationsByDate[month] || 0);
            const monthlyRequests = sortedAllMonths.map(month => requestsByDate[month] || 0);

            charts.monthlyTrends = new Chart(document.getElementById('monthlyTrendsChart'), {
                type: 'bar',
                data: {
                    labels: sortedAllMonths.map(d => {
                        const [year, month] = d.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Donations',
                        data: monthlyDonations,
                        backgroundColor: '#4a0404'
                    }, {
                        label: 'Requests',
                        data: monthlyRequests,
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateStats(donors, requests) {
            document.getElementById('totalDonors').textContent = donors.length;
            document.getElementById('totalRequests').textContent = requests.length;
            const available = donors.filter(d => d.availability === 'Yes').length;
            document.getElementById('availableDonors').textContent = available;
        }

        function displayDonors(donors) {
            if (donors.length === 0) {
                donorsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div class="empty-state-text">No donors found.</div></div>';
                return;
            }

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Blood Group</th>
                        <th>Contact</th>
                        <th>Availability</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            donors.forEach(donor => {
                html += `
                    <tr>
                        <td><strong>${donor.fullName}</strong></td>
                        <td>${donor.age}</td>
                        <td>${donor.gender}</td>
                        <td><span class="badge badge-danger">${donor.bloodGroup}</span></td>
                        <td>${donor.contact}</td>
                        <td>
                            <select class="select-input availability-select" data-id="${donor.id}">
                                <option value="Yes" ${donor.availability === 'Yes' ? 'selected' : ''}>Yes</option>
                                <option value="No" ${donor.availability === 'No' ? 'selected' : ''}>No</option>
                            </select>
                        </td>
                        <td style="vertical-align: middle;">
                            <button class="action-btn" onclick="deleteDonor('${donor.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            donorsContainer.innerHTML = html;

            // Add event listeners for availability changes
            document.querySelectorAll('.availability-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const donorId = e.target.dataset.id;
                    const availability = e.target.value;
                    const result = await adminUpdateDonorAvailability(donorId, availability);
                    if (result.success) {
                        showSuccessToast('Donor availability updated successfully!');
                        loadData();
                    } else {
                        showErrorToast('Failed to update availability.');
                        loadData();
                    }
                });
            });
        }

        async function displayRequests(requests) {
            if (requests.length === 0) {
                requestsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></div><div class="empty-state-text">No blood requests found.</div></div>';
                return;
            }

            // Get all donors to check availability
            const donorsResult = await getAllDonors();
            const donors = donorsResult.success ? donorsResult.donors : [];

            let html = `<table class="data-table">
                <thead>
                    <tr>
                        <th>Requester</th>
                        <th>Blood Group</th>
                        <th>Contact</th>
                        <th>Department</th>
                        <th>Reason</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;

            requests.forEach(request => {
                const date = new Date(request.timestamp);
                // Use fullName if available, otherwise use requesterName, fallback to email
                const requesterDisplay = request.fullName || request.requesterName || request.userEmail || 'Unknown';

                // Check if request is completed
                const isCompleted = request.status === 'completed';

                // Check if there's an available donor with matching blood group
                // If a specific donor was requested, check if that donor is available
                let hasAvailableDonor = false;
                if (!isCompleted) {
                    if (request.requestedDonorId) {
                        // Check if the specific requested donor is available
                        const requestedDonor = donors.find(d => d.id === request.requestedDonorId);
                        hasAvailableDonor = requestedDonor &&
                            requestedDonor.bloodGroup === request.bloodGroup &&
                            requestedDonor.availability === 'Yes';
                    } else {
                        // Fallback: check if any donor with matching blood group is available
                        hasAvailableDonor = donors.some(donor =>
                            donor.bloodGroup === request.bloodGroup && donor.availability === 'Yes'
                        );
                    }
                }

                // Status badge
                const statusBadge = isCompleted
                    ? '<span class="badge" style="background-color: #10b981;">Completed</span>'
                    : '<span class="badge" style="background-color: #f59e0b;">Pending</span>';

                // Show requested donor name if available
                const donorInfo = request.requestedDonorName
                    ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Donor: ${request.requestedDonorName}</div>`
                    : '';

                html += `
                    <tr>
                        <td><strong>${requesterDisplay}</strong></td>
                        <td><span class="badge badge-danger">${request.bloodGroup}</span>${donorInfo}</td>
                        <td>${request.contact !== '-' ? request.contact : (request.userEmail || '-')}</td>
                        <td>${request.department !== '-' ? request.department : '-'}</td>
                        <td>${request.reason !== '-' ? request.reason : '-'}</td>
                        <td>${date.toLocaleDateString()}</td>
                        <td>${statusBadge}</td>
                        <td style="vertical-align: middle;">
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                ${!isCompleted ? `
                                    <button class="action-btn" 
                                        onclick="approveRequestAction('${request.id}', '${request.bloodGroup}', '${request.requestedDonorId || ''}')" 
                                        ${hasAvailableDonor ? 'style="background-color: #10b981; color: white;"' : 'disabled style="opacity: 0.5; cursor: not-allowed; background-color: #6b7280;"'}
                                        title="${hasAvailableDonor ? (request.requestedDonorName ? `Approve request - ${request.requestedDonorName}` : 'Approve request') : (request.requestedDonorId ? `Requested donor ${request.requestedDonorName || 'is'} no longer available` : 'No available donor with matching blood group')}">
                                        Approve
                                    </button>
                                ` : ''}
                                <button class="action-btn" onclick="deleteRequest('${request.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            requestsContainer.innerHTML = html;
        }

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.data-table tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Tab filtering
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function () {
                const section = this.closest('.data-section');
                section.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                // Add filtering logic here if needed
            });
        });

        // Make functions available globally
        window.deleteDonor = async (donorId) => {
            const confirmed = await showConfirm(
                'Delete Donor',
                'Are you sure you want to delete this donor record? This action cannot be undone.',
                true // isDanger = true for delete actions
            );
            if (confirmed) {
                const result = await adminDeleteDonor(donorId);
                if (result.success) {
                    showSuccessToast('Donor deleted successfully!');
                    loadData();
                } else {
                    showErrorToast('Failed to delete donor.');
                }
            }
        };

        window.deleteRequest = async (requestId) => {
            const confirmed = await showConfirm(
                'Delete Request',
                'Are you sure you want to delete this blood request? This action cannot be undone.',
                true // isDanger = true for delete actions
            );
            if (confirmed) {
                const result = await adminDeleteRequest(requestId);
                if (result.success) {
                    showSuccessToast('Request deleted successfully!');
                    loadData();
                } else {
                    showErrorToast('Failed to delete request.');
                }
            }
        };

        window.approveRequestAction = async (requestId, bloodGroup, requestedDonorId = null) => {
            // Get request details to show donor name in confirmation
            const request = window.adminData?.requests?.find(r => r.id === requestId);
            const donorName = request?.requestedDonorName ? ` from ${request.requestedDonorName}` : '';

            const confirmed = await showConfirm(
                'Approve Request',
                `Approve this blood request for ${bloodGroup}${donorName}? This will assign the requested donor and mark the request as completed.`
            );
            if (confirmed) {
                const result = await approveRequest(requestId, bloodGroup, requestedDonorId || null);
                if (result.success) {
                    showSuccessToast(`Request approved successfully! Donor ${result.donorName} has been assigned.`);
                    loadData();
                } else {
                    showErrorToast(result.error || 'Failed to approve request.');
                }
            }
        };

        refreshBtn.addEventListener('click', () => {
            loadData();
            showSuccessToast('Data refreshed!');

            // Refresh analytics if on analytics page
            const currentPage = document.querySelector('.page-content[style*="block"]') || document.querySelector('.page-content:not([style*="none"])');
            if (currentPage && currentPage.id === 'page-analytics') {
                loadAnalytics();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            sessionStorage.removeItem('adminLoggedIn');
            sessionStorage.removeItem('adminEmail');
            const result = await logOut();
            if (result.success || true) {
                window.location.href = window.getPath('index');
            }
        });

        // Top header background on scroll
        const topHeader = document.querySelector('.top-header');
        if (topHeader) {
            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > 50) {
                    topHeader.classList.add('scrolled');
                } else {
                    topHeader.classList.remove('scrolled');
                }
            });
        }
    </script>
</body>

</html>